name: Autobuild Check Logic Test

on:
  workflow_dispatch:

jobs:
  check_autobuild_logic:
    name: Check Autobuild Should Run Logic
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check if version or source changed, or assets already exist
        id: check
        run: |
          # # ä»…ç”¨äºæµ‹è¯•é€»è¾‘ï¼Œæ‰‹åŠ¨è§¦å‘è‡ªåŠ¨è·³è¿‡
          # if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          #   echo "should_run=skip" >> $GITHUB_OUTPUT
          #   echo "ğŸŸ¡ æ‰‹åŠ¨è§¦å‘ï¼Œè·³è¿‡ should_run æ£€æŸ¥"
          #   exit 0
          # fi

          # ç¡®ä¿æœ‰ HEAD~1
          if ! git rev-parse HEAD~1 > /dev/null 2>&1; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ æ²¡æœ‰å‰ä¸€ä¸ªæäº¤ï¼Œé»˜è®¤éœ€è¦æ„å»º"
            exit 0
          fi

          # ç‰ˆæœ¬å·å˜æ›´åˆ¤æ–­
          CURRENT_VERSION=$(jq -r '.version' package.json)
          PREVIOUS_VERSION=$(git show HEAD~1:package.json | jq -r '.version' 2>/dev/null || echo "")

          if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ ç‰ˆæœ¬å·å˜æ›´: $PREVIOUS_VERSION â†’ $CURRENT_VERSION"
            exit 0
          fi

          # æ£€æŸ¥ src å˜æ›´ï¼ˆæ’é™¤å¸¸è§äº§ç‰©ä¸ç¼“å­˜ï¼‰
          SRC_DIFF=$(git diff --name-only HEAD~1 HEAD -- src/ | grep -Ev '^src/(dist|build|node_modules|\.next|\.cache)' || true)
          TAURI_DIFF=$(git diff --name-only HEAD~1 HEAD -- src-tauri/ | grep -Ev '^src-tauri/(target|node_modules|dist|\.cache)' || true)

          if [ -n "$SRC_DIFF" ] || [ -n "$TAURI_DIFF" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ æºç å˜æ›´ detected"
            exit 0
          fi

          # æ‰¾åˆ°æœ€åä¸€ä¸ªä¿®æ”¹ Tauri ç›¸å…³æ–‡ä»¶çš„ commit
          echo "ğŸ” æŸ¥æ‰¾æœ€åä¸€ä¸ª Tauri ç›¸å…³å˜æ›´çš„ commit..."

          LAST_TAURI_COMMIT=""
          for commit in $(git rev-list HEAD --max-count=50); do
            # æ£€æŸ¥æ­¤ commit æ˜¯å¦ä¿®æ”¹äº† Tauri ç›¸å…³æ–‡ä»¶
            CHANGED_FILES=$(git show --name-only --pretty=format: $commit | tr '\n' ' ')
            HAS_TAURI_CHANGES=false
            
            # æ£€æŸ¥å„ä¸ªæ¨¡å¼
            if echo "$CHANGED_FILES" | grep -q "src/" && echo "$CHANGED_FILES" | grep -qvE "src/(dist|build|node_modules|\.next|\.cache)"; then
              HAS_TAURI_CHANGES=true
            elif echo "$CHANGED_FILES" | grep -qE "src-tauri/(src|Cargo\.(toml|lock)|tauri\..*\.conf\.json|build\.rs|capabilities)"; then
              HAS_TAURI_CHANGES=true
            fi
            
            if [ "$HAS_TAURI_CHANGES" = true ]; then
              LAST_TAURI_COMMIT=$(git rev-parse --short $commit)
              break
            fi
          done

          if [ -z "$LAST_TAURI_COMMIT" ]; then
            echo "âš ï¸  æœ€è¿‘çš„ commits ä¸­æœªæ‰¾åˆ° Tauri ç›¸å…³å˜æ›´ï¼Œä½¿ç”¨å½“å‰ commit"
            LAST_TAURI_COMMIT=$(git rev-parse --short HEAD)
          fi

          CURRENT_COMMIT=$(git rev-parse --short HEAD)
          echo "ğŸ“ æœ€å Tauri ç›¸å…³ commit: $LAST_TAURI_COMMIT"
          echo "ğŸ“ å½“å‰ commit: $CURRENT_COMMIT"

          # æ£€æŸ¥ autobuild release æ˜¯å¦å­˜åœ¨
          AUTOBUILD_RELEASE_EXISTS=$(gh release view "autobuild" --json id -q '.id' 2>/dev/null || echo "")

          if [ -z "$AUTOBUILD_RELEASE_EXISTS" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "ğŸŸ¢ æ²¡æœ‰ autobuild releaseï¼Œéœ€æ„å»º"
          else
            # æ£€æŸ¥ latest.json æ˜¯å¦å­˜åœ¨
            LATEST_JSON_EXISTS=$(gh release view "autobuild" --json assets -q '.assets[] | select(.name == "latest.json") | .name' 2>/dev/null || echo "")
            
            if [ -z "$LATEST_JSON_EXISTS" ]; then
              echo "should_run=true" >> $GITHUB_OUTPUT
              echo "ğŸŸ¢ æ²¡æœ‰ latest.jsonï¼Œéœ€æ„å»º"
            else
              # ä¸‹è½½å¹¶è§£æ latest.json æ£€æŸ¥ç‰ˆæœ¬å’Œ commit hash
              echo "ğŸ“¥ ä¸‹è½½ latest.json æ£€æŸ¥ç‰ˆæœ¬..."
              LATEST_JSON_URL=$(gh release view "autobuild" --json assets -q '.assets[] | select(.name == "latest.json") | .browser_download_url' 2>/dev/null)
              
              if [ -n "$LATEST_JSON_URL" ]; then
                LATEST_JSON_CONTENT=$(curl -s "$LATEST_JSON_URL" 2>/dev/null || echo "")
                
                if [ -n "$LATEST_JSON_CONTENT" ]; then
                  LATEST_VERSION=$(echo "$LATEST_JSON_CONTENT" | jq -r '.version' 2>/dev/null || echo "")
                  echo "ğŸ“¦ æœ€æ–° autobuild ç‰ˆæœ¬: $LATEST_VERSION"
                  
                  # ä»ç‰ˆæœ¬å­—ç¬¦ä¸²ä¸­æå– commit hash (æ ¼å¼: X.Y.Z+autobuild.MMDD.commit)
                  LATEST_COMMIT=$(echo "$LATEST_VERSION" | sed -n 's/.*+autobuild\.[0-9]\{4\}\.\([a-f0-9]*\)$/\1/p' || echo "")
                  echo "ğŸ“ æœ€æ–° autobuild commit: $LATEST_COMMIT"
                  
                  if [ "$LAST_TAURI_COMMIT" != "$LATEST_COMMIT" ]; then
                    echo "should_run=true" >> $GITHUB_OUTPUT
                    echo "ğŸŸ¢ Tauri commit hash ä¸åŒ¹é… ($LAST_TAURI_COMMIT != $LATEST_COMMIT)ï¼Œéœ€æ„å»º"
                  else
                    echo "should_run=false" >> $GITHUB_OUTPUT
                    echo "ğŸ”´ ç›¸åŒ Tauri commit hash ($LAST_TAURI_COMMIT)ï¼Œä¸éœ€æ„å»º"
                  fi
                else
                  echo "should_run=true" >> $GITHUB_OUTPUT
                  echo "âš ï¸  æ— æ³•ä¸‹è½½æˆ–è§£æ latest.jsonï¼Œéœ€æ„å»º"
                fi
              else
                echo "should_run=true" >> $GITHUB_OUTPUT
                echo "âš ï¸  æ— æ³•è·å– latest.json ä¸‹è½½ URLï¼Œéœ€æ„å»º"
              fi
            fi
          fi

      - name: Output should_run result
        run: |
          echo "Result: ${{ steps.check.outputs.should_run }}"
