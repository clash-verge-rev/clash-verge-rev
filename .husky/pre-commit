#!/bin/bash
set -euo pipefail

echo "[pre-commit] Running pre-commit checks..."

# --- JS/TS stage check ---
JS_FILES=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$JS_FILES" ]; then
  echo "[pre-commit] JS/TS files detected. Running lint-staged..."
  npx lint-staged

  echo "[pre-commit] Verifying no remaining ESLint issues..."
  if ! pnpm lint:staged --max-warnings 0; then
    echo "❌ ESLint found unfixable issues or warnings in staged JS/TS files."
    echo "Files affected: $JS_FILES"
    exit 1
  fi
else
  echo "[pre-commit] No JS/TS files staged. Skipping lint-staged."
fi

# --- Rust stage check ---
RUST_FILES=$(git diff --cached --name-only | grep -E '^src-tauri/.*\.rs$' || true)
if [ -n "$RUST_FILES" ]; then
  echo "[pre-commit] Rust files detected. Running rustfmt + clippy..."

  # Auto-format
  cargo fmt --manifest-path ./src-tauri/Cargo.toml

  # Verify format
  if ! cargo fmt --manifest-path ./src-tauri/Cargo.toml -- --check; then
    echo "❌ rustfmt found issues after auto-formatting."
    exit 1
  fi

  # Run clippy with warnings as errors
  if ! cargo clippy --manifest-path ./src-tauri/Cargo.toml -- -D warnings; then
    echo "❌ clippy found issues. Please fix them before committing."
    exit 1
  fi
else
  echo "[pre-commit] No Rust files staged. Skipping clippy."
fi

echo "✅ All pre-commit checks passed!"
exit 0
