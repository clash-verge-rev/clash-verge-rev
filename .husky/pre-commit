#!/bin/bash
set -euo pipefail

echo "[pre-commit] Running pre-commit checks..."

# --- JS/TS: 只检查新增/修改的行 ---
JS_FILES=$(git diff --cached --name-only | grep -E '\.(ts|tsx|js|jsx)$' || true)
if [ -n "$JS_FILES" ]; then
  echo "[pre-commit] Running lint-staged..."
  npx lint-staged  # lint-staged 已经只检查 staged changes

  # 不再运行全局 lint,因为 lint-staged 已经处理了
  echo "✅ Staged JS/TS files checked"
else
  echo "[pre-commit] No JS/TS files staged."
fi

# --- Rust: 只 format,不严格检查 ---
RUST_FILES=$(git diff --cached --name-only | grep -E '^src-tauri/.*\.rs$' || true)
if [ -n "$RUST_FILES" ]; then
  echo "[pre-commit] Formatting Rust files..."
  cargo fmt --manifest-path ./src-tauri/Cargo.toml

  # 只显示 clippy 建议,不阻止提交
  echo "[pre-commit] Running clippy (warnings allowed)..."
  cargo clippy --manifest-path ./src-tauri/Cargo.toml 2>&1 | head -n 20 || true

  echo "✅ Rust files formatted"
else
  echo "[pre-commit] No Rust files staged."
fi

echo "✅ Pre-commit checks completed!"
