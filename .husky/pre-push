#!/bin/bash

if git diff --cached --name-only | grep -q '^src-tauri/'; then
    cargo clippy --manifest-path ./src-tauri/Cargo.toml
    if [ $? -ne 0 ]; then
        echo "Clippy found issues in src-tauri. Please fix them before pushing."
        exit 1
    fi
fi

remote_name="$1"
if [ -z "$remote_name" ]; then
    echo "[pre-push] No remote name provided. Skipping format check."
    exit 0
fi
remote_url=$(git remote get-url "$remote_name" 2>/dev/null)
if [ $? -ne 0 ]; then
    echo "[pre-push] Remote '$remote_name' not found. Skipping format check."
    exit 0
fi

if [[ "$remote_url" =~ github\.com[:/]+clash-verge-rev/clash-verge-rev(\.git)?$ ]]; then
    echo "[pre-push] Detected push to clash-verge-rev/clash-verge-rev ($remote_url)"
    echo "[pre-push] Running pnpm format:check..."

    pnpm format:check
    if [ $? -ne 0 ]; then
        echo "‚ùå Code format check failed. Please fix formatting before pushing."
        exit 1
    fi
else
    echo "[pre-push] Not pushing to target repo. Skipping format check."
fi

exit 0
