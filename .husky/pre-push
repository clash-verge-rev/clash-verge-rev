#!/bin/bash
set -euo pipefail

# $1: remote name (e.g., origin)
# $2: remote url (e.g., git@github.com:clash-verge-rev/clash-verge-rev.git)

REMOTE_NAME="$1"
REMOTE_URL=$(git remote get-url "$REMOTE_NAME" 2>/dev/null || echo "")

echo "[pre-push] Running pre-push checks..."

# --- Rust-related check (only if src-tauri changes staged) ---
if git diff --cached --name-only | grep -q '^src-tauri/'; then
  echo "[pre-push] Rust changes detected. Running cargo clippy..."
  cargo clippy --manifest-path ./src-tauri/Cargo.toml -- -D warnings || {
    echo "❌ Clippy found issues in src-tauri. Please fix them before pushing."
    exit 1
  }
else
  echo "[pre-push] No Rust changes detected. Skipping clippy."
fi

# --- Determine if pushing to main repo ---
if [[ "$REMOTE_URL" =~ github\.com[:/]+clash-verge-rev/clash-verge-rev(\.git)?$ ]]; then
  echo "[pre-push] Detected push to clash-verge-rev/clash-verge-rev ($REMOTE_URL)"
  echo "[pre-push] Running pnpm check (fmt + lint)..."

  pnpm check || {
    echo "❌ Lint or format check failed. Please fix issues before pushing."
    exit 1
  }
else
  echo "[pre-push] Not pushing to main repo ($REMOTE_URL). Skipping pnpm check."
fi

echo "✅ All pre-push checks passed!"
exit 0
